/*******************************************************************************
@author Tobias Falkenstein, fta1fe
@author ClaraSim is part of CLARA
@copyright (c) Copyright Robert Bosch GmbH 2024.  All rights reserved.
*******************************************************************************/
#define NOMINMAX

#include <cassert>
#include <cstdlib>
#include <fstream>
#include <iostream>

#include "CRadarReflectionModel.h"

// Variational radar model parameters.
// See https://github.com/A-Scheel/Variational-Radar-Model
// The marginal statistics were obtained from the publicly available model using MATLAB.
// Note: As per recommendation by Alexander Scheel, a Gaussian mixture model instead of a Student-t model is used here for simplicity.

// Doppler velocity error is not considered here -> 3 instead of 4 dimensions.
static arma::uword vrmNvars = 3;
static arma::uword vrmNgauss = 50;
// Variable offsets to have z_x and z_y in range [0, 1], see Fig. 5 in https://arxiv.org/pdf/1711.03799.pdf.
static double vrmZxOffset = 0.22;
static double vrmZyOffset = 0.5;
// clang-format off
// The following arrays are formatted for direct use in the armadillo library.
// Mean values for each of the 50 Gaussian distributions for aspect angle [rad], z_x [-], z_y [-]
static arma::mat vrmMeans = {
  { -2.2707607171866906e+00, -1.8352569339061244e+00, -6.9856738405995167e-01,  7.1610007753132932e-01,  2.3698249025900830e+00, -6.8242187401443333e-01, -1.7938915168084002e+00,  1.6787271819386658e+00,  1.5924425111100660e+00,  1.4492754328863382e+00,  1.4683958824611050e+00, -2.2567520019205611e+00, -2.2713747973725988e+00,  2.2421213920066307e-02, -1.4722158575171205e+00,  2.2081486132296915e+00,  2.6451764832311442e+00,  2.8631490017645032e+00,  1.7838310287932253e+00, -2.6880693541786300e+00,  8.8383557508238852e-01, -2.6212720301778458e+00, -2.4052699125958581e+00, -2.1000653440368753e+00,  7.3753038976764984e-01, -9.1895681192346768e-01,  7.4799729524092040e-01, -8.3899792609389756e-01, -8.6956813830649382e-01, -2.9006705002979789e+00,  2.7619928757598855e-01, -1.8236845330590030e+00, -1.8200276233823256e+00, -1.8634796557685411e+00,  1.8159061094788060e+00, -1.1369224256467905e+00, -6.5619342645919765e-01, -2.0213801454120731e-01,  2.3157193309949111e+00,  2.7180374155532441e+00,  1.7627712220296960e+00,  3.8636854172956692e-01, -5.0868860206153743e-01,  5.6932968675666981e-02, -1.0740221681332680e+00, -1.5946451045361374e+00,  2.3082393861198822e+00,  1.8029019319822428e+00,  1.3882429074917910e+00,  1.3226145428066491e+00 },
  {  5.8150386449694735e-01,  1.1223049793872630e-01,  5.7682770756108415e-01, -1.9054226989350051e-01,  6.6040829189423333e-01,  5.2565626048346532e-02,  1.5496707815012994e-01,  2.9139841339857675e-01,  5.0312126390732270e-01,  7.0819926526650340e-02, -2.2290554566540235e-02,  3.6917599517667271e-01, -7.0934577738137425e-02, -2.2119549341998054e-01, -4.4566453301858801e-02,  6.2686696223127125e-01,  5.2314753592604413e-01,  7.2057011307402219e-01,  2.6846764175912657e-01,  6.7138491342332540e-01,  1.7313058940481177e-01,  7.0887335639495486e-01,  5.7766597896458272e-01,  3.5193698875089202e-01, -1.7256317783257447e-01,  5.8403817631662935e-01, -4.7592742943258270e-02, -4.2281228635634133e-02, -8.2513714785983447e-02,  7.2979958106317955e-01,  3.9879255694888838e-01,  1.6102923543646536e-01,  3.4295048779722836e-01,  5.5375377446957808e-01,  3.3026413116667475e-01,  4.3868444469009160e-01, -1.0071229347744749e-01, -2.1380126704629926e-01, -5.3769507913452308e-02,  7.2314576757041538e-01,  1.1901987444632750e-01, -2.4665075763724238e-02, -2.3399339142267248e-01, -3.0527565916134588e-02, -2.6157475503949617e-03,  5.7546703432168622e-01,  5.7629861669632010e-01,  5.6627716567671316e-01,  6.2520138516045309e-01, -3.9528180920082564e-03 },
  { -4.9673558972431531e-01, -6.9103679983696473e-02, -4.7601061091710756e-01,  1.1400347812229386e-02,  3.1275233357841359e-01,  4.9509047569004044e-01,  3.5904166182288322e-01,  1.6029220516783041e-01,  4.8116798468369648e-01,  4.7303087593104365e-01,  4.6565507056977218e-01,  3.2052646606112561e-01, -4.5421677653793963e-01,  3.7739531573439775e-02, -4.5175866019371486e-01, -3.9569591637655571e-01, -6.4525693053358701e-02,  5.5290735654249301e-02,  4.5989964183912158e-01, -3.6887299182054928e-01, -1.6316169592202420e-01,  8.1684413859822044e-02, -4.0260303079099474e-01, -4.8846727576212368e-01,  3.3978205481954910e-01, -4.2063723581223278e-01,  4.5493794016971173e-01, -3.3353079761316196e-01, -4.2283545375788645e-01, -2.1496031912896868e-01,  1.6653589092793383e-01, -4.1670822323595602e-01, -4.8776658035874032e-01,  4.0186222874051875e-01,  1.1303447036454520e-01, -1.8937335556869558e-01, -4.4946600328935582e-01, -8.3713024504736583e-02,  4.1742016228699208e-01, -5.8524676027938385e-02, -4.9355026392309143e-01,  5.0779682286222549e-01,  1.5454024437618696e-01,  1.5564311632354196e-02, -4.8882693818003686e-01, -4.7899732491309405e-01,  4.6619137816003026e-01,  4.5955720446874648e-01,  5.3445031139727339e-01,  4.8602100075189819e-01 }
  };
// Covariance matrices for each of the 50 Gaussian distributions.
static ::std::vector<arma::mat> vrmCovariances = {
 { { 0.049340423587, -0.003825848187, 0.000701985027 },
   { -0.003825848187, 0.007243328187, 0.003041382868 },
   { 0.000701985027, 0.003041382868, 0.004668296175 } },
 { { 2.109007633303, -0.213549682642, 0.223834948108 },
   { -0.213549682642, 0.127713064864, -0.033103496432 },
   { 0.223834948108, -0.033103496432, 0.179550124737 } },
 { { 0.034945005261, -0.001265624340, 0.001193995582 },
   { -0.001265624340, 0.003215824220, -0.000244898096 },
   { 0.001193995582, -0.000244898096, 0.009432485005 } },
 { { 0.083311791098, 0.001499947308, 0.022716893568 },
   { 0.001499947308, 0.005897140561, 0.006439712694 },
   { 0.022716893568, 0.006439712694, 0.064955040418 } },
 { { 0.097944250905, -0.005112390922, 0.014349038856 },
   { -0.005112390922, 0.007923870807, -0.008700574186 },
   { 0.014349038856, -0.008700574186, 0.030145023861 } },
 { { 0.086494185561, -0.034840610921, 0.008273964561 },
   { -0.034840610921, 0.070401595279, 0.000637709818 },
   { 0.008273964561, 0.000637709818, 0.032757429632 } },
 { { 0.104480723682, -0.031118741236, -0.000147808882 },
   { -0.031118741236, 0.035015378760, -0.010525680285 },
   { -0.000147808882, -0.010525680285, 0.047677479317 } },
 { { 0.351682471490, -0.094967806325, -0.064900187141 },
   { -0.094967806325, 0.044473235458, 0.011936230565 },
   { -0.064900187141, 0.011936230565, 0.063364952300 } },
 { { 0.480354293008, -0.016245970414, 0.002380121734 },
   { -0.016245970414, 0.026015496210, 0.005541956252 },
   { 0.002380121734, 0.005541956252, 0.022636664391 } },
 { { 0.298700250291, 0.031516501316, 0.009543588667 },
   { 0.031516501316, 0.025625195663, 0.003657169961 },
   { 0.009543588667, 0.003657169961, 0.004396523944 } },
 { { 0.577206196614, 0.008732141620, -0.009964952109 },
   { 0.008732141620, 0.003604131793, -0.000525478809 },
   { -0.009964952109, -0.000525478809, 0.007683767544 } },
 { { 0.234348764155, -0.083931300097, 0.032096094577 },
   { -0.083931300097, 0.083114333730, -0.002306344125 },
   { 0.032096094577, -0.002306344125, 0.072076670907 } },
 { { 0.121640302966, -0.003047291652, 0.008017754278 },
   { -0.003047291652, 0.009801131860, 0.003069595456 },
   { 0.008017754278, 0.003069595456, 0.015686408996 } },
 { { 0.036448304664, 0.000188654137, 0.040092899971 },
   { 0.000188654137, 0.000789688021, 0.000434509681 },
   { 0.040092899971, 0.000434509681, 0.057848551406 } },
 { { 0.051615782719, -0.003486493057, 0.005295976466 },
   { -0.003486493057, 0.012544886290, -0.002532677186 },
   { 0.005295976466, -0.002532677186, 0.005407837721 } },
 { { 0.318784877270, 0.020633645443, -0.023364563072 },
   { 0.020633645443, 0.008204269190, -0.002353187990 },
   { -0.023364563072, -0.002353187990, 0.013962166089 } },
 { { 0.121511395907, -0.001138723923, -0.026828758804 },
   { -0.001138723923, 0.019054232249, -0.018951191186 },
   { -0.026828758804, -0.018951191186, 0.099865517411 } },
 { { 0.041405946453, 0.000937494518, -0.006856900569 },
   { 0.000937494518, 0.001345786339, -0.002107407879 },
   { -0.006856900569, -0.002107407879, 0.071622955581 } },
 { { 0.059638409822, 0.019630529533, 0.004841626381 },
   { 0.019630529533, 0.065343202888, -0.003268592407 },
   { 0.004841626381, -0.003268592407, 0.006411241928 } },
 { { 0.056311224193, -0.006912285238, 0.007280176881 },
   { -0.006912285238, 0.004404913761, 0.005673923333 },
   { 0.007280176881, 0.005673923333, 0.041882144799 } },
 { { 1.350200951271, 0.111392861650, -0.061934278657 },
   { 0.111392861650, 0.073985870322, -0.003358092795 },
   { -0.061934278657, -0.003358092795, 0.124917704351 } },
 { { 0.095264046247, -0.000072320302, -0.036252907182 },
   { -0.000072320302, 0.003489252486, 0.000939257591 },
   { -0.036252907182, 0.000939257591, 0.064395776765 } },
 { { 0.100637684631, 0.014678575261, 0.011818440657 },
   { 0.014678575261, 0.010905526024, 0.004569304429 },
   { 0.011818440657, 0.004569304429, 0.018324069441 } },
 { { 0.301175228484, 0.049046402732, 0.000024021137 },
   { 0.049046402732, 0.074139132726, -0.001192515731 },
   { 0.000024021137, -0.001192515731, 0.025211866122 } },
 { { 0.101297754586, 0.000414315451, 0.001618723144 },
   { 0.000414315451, 0.003486955578, 0.004283480491 },
   { 0.001618723144, 0.004283480491, 0.019157675934 } },
 { { 0.117908765948, -0.003577737603, 0.001819784165 },
   { -0.003577737603, 0.005457170749, -0.001038593482 },
   { 0.001819784165, -0.001038593482, 0.013150038242 } },
 { { 0.095156990184, 0.008933313692, -0.020651140026 },
   { 0.008933313692, 0.009078289769, 0.001342006515 },
   { -0.020651140026, 0.001342006515, 0.025564418393 } },
 { { 0.123373448570, -0.019752718662, -0.015456495858 },
   { -0.019752718662, 0.015379154236, -0.007566494729 },
   { -0.015456495858, -0.007566494729, 0.044441891799 } },
 { { 0.112211865093, 0.005251803159, -0.002490284337 },
   { 0.005251803159, 0.011372031271, -0.004186830986 },
   { -0.002490284337, -0.004186830986, 0.008492366600 } },
 { { 0.031711305469, -0.001281991878, -0.008004218800 },
   { -0.001281991878, 0.001226772700, 0.002271868922 },
   { -0.008004218800, 0.002271868922, 0.033509998940 } },
 { { 0.185902057810, 0.053772415538, 0.098824891968 },
   { 0.053772415538, 0.033792591232, 0.037185968126 },
   { 0.098824891968, 0.037185968126, 0.109722126449 } },
 { { 0.062635251248, 0.001105379272, 0.004216273045 },
   { 0.001105379272, 0.056436750135, 0.023595578539 },
   { 0.004216273045, 0.023595578539, 0.027061732079 } },
 { { 0.090327839793, -0.011230844820, 0.004357491233 },
   { -0.011230844820, 0.042544807739, 0.001611639438 },
   { 0.004357491233, 0.001611639438, 0.003750101778 } },
 { { 0.392303227004, -0.031212053839, 0.009942120302 },
   { -0.031212053839, 0.019390957096, -0.008856826777 },
   { 0.009942120302, -0.008856826777, 0.024415798503 } },
 { { 1.376059912236, -0.132306160373, -0.208754087024 },
   { -0.132306160373, 0.095905358720, 0.037233374260 },
   { -0.208754087024, 0.037233374260, 0.219301933514 } },
 { { 0.177552225021, 0.023005555329, 0.049121054620 },
   { 0.023005555329, 0.012308007544, -0.000410082818 },
   { 0.049121054620, -0.000410082818, 0.037612197654 } },
 { { 0.241605405453, 0.014329094591, -0.015435363428 },
   { 0.014329094591, 0.015751351662, -0.003816716881 },
   { -0.015435363428, -0.003816716881, 0.019110011898 } },
 { { 0.260123731100, -0.001372901722, 0.018747041622 },
   { -0.001372901722, 0.001192919536, -0.001591791980 },
   { 0.018747041622, -0.001591791980, 0.062949042286 } },
 { { 0.108657792525, 0.004362517322, 0.001030124114 },
   { 0.004362517322, 0.008380879094, -0.002971985807 },
   { 0.001030124114, -0.002971985807, 0.013171791625 } },
 { { 0.068364695087, -0.000332153500, -0.014825286684 },
   { -0.000332153500, 0.004861818516, -0.006470203444 },
   { -0.014825286684, -0.006470203444, 0.104025742666 } },
 { { 0.108953012986, 0.046184434438, -0.041077438434 },
   { 0.046184434438, 0.043011514216, -0.020972028049 },
   { -0.041077438434, -0.020972028049, 0.039853490967 } },
 { { 0.006511562789, -0.000286497618, 0.001305180336 },
   { -0.000286497618, 0.002707070724, -0.000125667832 },
   { 0.001305180336, -0.000125667832, 0.007163049296 } },
 { { 0.182509506847, 0.009939024515, 0.081889186393 },
   { 0.009939024515, 0.003389640860, 0.001393140282 },
   { 0.081889186393, 0.001393140282, 0.086245985264 } },
 { { 0.362974353674, 0.011488853976, 0.033192705996 },
   { 0.011488853976, 0.004057444533, 0.003028061565 },
   { 0.033192705996, 0.003028061565, 0.084937569184 } },
 { { 0.179256798852, -0.001543568938, 0.001707072892 },
   { -0.001543568938, 0.002581985811, 0.000254072460 },
   { 0.001707072892, 0.000254072460, 0.003814574966 } },
 { { 0.165233792613, 0.006851950937, -0.004226846213 },
   { 0.006851950937, 0.007502155756, -0.004023858518 },
   { -0.004226846213, -0.004023858518, 0.007689536843 } },
 { { 0.077908083578, 0.007574489641, 0.003104005274 },
   { 0.007574489641, 0.006170356539, -0.000584432237 },
   { 0.003104005274, -0.000584432237, 0.003615626010 } },
 { { 0.392361921106, -0.010158888467, 0.004586088531 },
   { -0.010158888467, 0.010462175397, -0.000866569928 },
   { 0.004586088531, -0.000866569928, 0.005693483450 } },
 { { 0.153710600547, -0.007531773674, -0.009005151332 },
   { -0.007531773674, 0.007946700633, 0.003968517900 },
   { -0.009005151332, 0.003968517900, 0.010322396457 } },
 { { 0.052368354001, -0.002248482716, -0.006155497400 },
   { -0.002248482716, 0.015844918758, 0.007428269000 },
   { -0.006155497400, 0.007428269000, 0.009378180257 } }
};
// Mixing coefficients for the Gaussian mixture model (GMM).
// Note: Mixing coefficients must sum to unity, otherwise arma::gmm.generate() returns wrong results!
static arma::rowvec vrmMixCoeffs = { 2.5344878589505029e-02, 3.6265585006306001e-03, 5.0023388902587871e-03, 1.4908194253121168e-02, 2.9278326662223523e-02, 2.0365108618190142e-03, 6.0895920203321244e-03, 8.9297594434006138e-03, 6.3861766235090312e-03, 3.9344645427273159e-02, 1.9324720036585162e-02, 9.6401680883575740e-03, 1.8954008139139455e-02, 4.4458712982789292e-02, 3.1279669685815623e-02, 7.3872311508754191e-03, 6.4502020498710608e-03, 5.1801725024813026e-02, 2.6769067442566588e-02, 2.2714589265925001e-02, 9.9241096169366185e-03, 2.8823792826832922e-02, 2.2936475584620492e-02, 6.0367848622939887e-03, 3.4174293259311310e-02, 2.2246882717351212e-02, 2.2143476267556722e-02, 1.8816483889896134e-02, 3.3155896019670769e-02, 3.9909828698394718e-02, 1.4175067799992185e-02, 1.3594933196633081e-02, 3.2167818109887558e-02, 6.1255789414179944e-03, 3.0904449360720384e-03, 9.0599226336876837e-03, 3.2407600497528890e-03, 6.1194721846721339e-02, 1.6010572033945254e-02, 1.6652950405662986e-02, 4.5104302162328764e-03, 5.3583581543952099e-03, 1.7977061139469994e-02, 2.2484605180886470e-02, 1.9006976292657050e-02, 2.6097902475791947e-02, 2.3248407346074616e-02, 3.7962303807259484e-02, 2.2526725211368042e-02, 2.7619361340415097e-02 };
// clang-format on

void CRadarReflectionModel::init() {
  // TODO(tobias): could pre-compute the conditional distributions for a configured aspect angle increment here.
}

void calcConditionalGMM(const arma::colvec& condVals, const arma::uvec& perm, gmmData& condGMM) {
  arma::uword nvars = vrmNvars - condVals.n_cols;
  // Reinitialize the output data struct.
  condGMM.means.resize(nvars, vrmNgauss);
  condGMM.means.fill(0.0);
  condGMM.covMats.resize(nvars, nvars, vrmNgauss);
  condGMM.covMats.fill(0.0);
  condGMM.mixCoeffs.resize(vrmNgauss);
  condGMM.mixCoeffs.fill(0.0);
  // Calculate the conditional GMM coefficients.
  arma::rowvec margProb_m(vrmNgauss, arma::fill::zeros);
  for (arma::uword g = 0; g < vrmNgauss; ++g) {
    // For each Gaussian, permute the variational radar model coefficient structs such that the conditioning variables are at the end.
    arma::mat covPerm(vrmNvars, vrmNvars, arma::fill::zeros);
    // Armadillo uses column-major order.
    for (arma::uword j = 0; j < vrmNvars; ++j) {
      for (arma::uword i = 0; i < vrmNvars; ++i) {
        covPerm(i, j) = vrmCovariances[g](perm(i), perm(j));
      }
    }
    // Calculate conditional means and covariance martix.
    // See https://en.wikipedia.org/wiki/Multivariate_normal_distribution -> Conditional distributions
    arma::mat cov_11(nvars, nvars, arma::fill::zeros);
    for (arma::uword j = 0; j < nvars; ++j) {
      for (arma::uword i = 0; i < nvars; ++i) {
        cov_11(i, j) = covPerm(i, j);
      }
    }
    arma::mat cov_12(nvars, vrmNvars - nvars, arma::fill::zeros);
    arma::mat cov_21(vrmNvars - nvars, nvars, arma::fill::zeros);
    for (arma::uword j = nvars; j < vrmNvars; ++j) {
      for (arma::uword i = 0; i < nvars; ++i) {
        cov_12(i, j - nvars) = covPerm(i, j);
        cov_21(j - nvars, i) = covPerm(j, i);
      }
    }
    arma::mat cov_22(vrmNvars - nvars, vrmNvars - nvars, arma::fill::zeros);
    for (arma::uword j = nvars; j < vrmNvars; ++j) {
      for (arma::uword i = nvars; i < vrmNvars; ++i) {
        cov_22(i - nvars, j - nvars) = covPerm(i, j);
      }
    }
    arma::colvec mean_1(nvars);
    arma::colvec mean_2(vrmNvars - nvars);
    for (arma::uword i = 0; i < vrmNvars; ++i) {
      if (i < nvars) {
        mean_1(i) = vrmMeans(perm(i), g);
      } else {
        mean_2(i - nvars) = vrmMeans(perm(i), g);
      }
    }
    arma::mat cov_22_inv = cov_22.i();
    arma::colvec mean_c = mean_1 + cov_12 * cov_22_inv * (condVals - mean_2);
    for (arma::uword i = 0; i < nvars; ++i) {
      condGMM.means(i, g) = mean_c(i);
    }
    arma::mat cov_c_m = cov_11 - cov_12 * cov_22_inv * cov_21;
    for (arma::uword j = 0; j < nvars; ++j) {
      for (arma::uword i = 0; i < nvars; ++i) {
        condGMM.covMats(i, j, g) = cov_c_m(i, j);
      }
    }
    // Verifiy the results with alternative calculation (can probably be removed in the future).
    arma::mat cov_c_2_m(nvars, nvars, arma::fill::zeros);
    covPerm = vrmCovariances[g].i();
    for (arma::uword j = 0; j < nvars; ++j) {
      for (arma::uword i = 0; i < nvars; ++i) {
        cov_c_2_m(i, j) = covPerm(perm(i), perm(j));
      }
    }
    cov_c_2_m = cov_c_2_m.i();
    cov_c_m -= cov_c_2_m;
    double max_err = arma::abs(cov_c_m).max();
    if (max_err > 1.0e-8) {
      throw std::runtime_error("Error in conditional covariance calculation.");
    }
    // Calculate GMM mixing coefficients.
    // See https://stats.stackexchange.com/questions/348941/general-conditional-distributions-for-multivariate-gaussian-mixtures
    if (condVals.n_cols == 1) {
      assert(cov_22(0) > 0);
      margProb_m(g) = arma::normpdf(condVals(0), mean_2(0), sqrt(cov_22(0)));
    } else {
      throw std::runtime_error(
          "Marginal pdf calculation only supported for 1 conditioning variable.");
    }
  }
  double sumMargProb = arma::sum(margProb_m);
  for (arma::uword g = 0; g < vrmNgauss; ++g) {
    condGMM.mixCoeffs(g) = vrmMixCoeffs(g) * margProb_m(g) / sumMargProb;
  }
  // Note: Mixing coefficients must sum to unity, otherwise arma::gmm.generate() returns wrong results!
  condGMM.mixCoeffs /= arma::sum(condGMM.mixCoeffs);
  // TODO(tobias): Here we could optimize by only considering the Gaussians with the largest mixing coefficient, up to a sum of say 0.99.
  /* arma::uvec i_max_v = sort_index(condGMM.mixCoeffs);
    for (arma::uword k = vrmNgauss - 1; k > vrmNgauss - 5; --k) {
      condGMM.mixCoeffs.col(i_max_v(k)).print("Significant mix. coeff.");
      condGMM.means.col(i_max_v(k)).print("Significant means");
      condGMM.covMats.slice(i_max_v(k)).print("Significant cov");
    }*/
}

void CRadarReflectionModel::getReflections(double aspect_angle,
                                           ::std::vector<vrmReflection>& reflections) {
  // Conditional model: Calculate GMM conditioned on given aspect angle.
  // Sort the variables such that the aspect angle is at the end instead of at the beginnig: Permute 1-2-0.
  arma::uvec perm = {1, 2, 0};
  arma::colvec condVals = {aspect_angle};
  gmmData condGMM;
  calcConditionalGMM(condVals, perm, condGMM);
  // Setup the armadillo conditional mixture model.
  arma::gmm_full gmm;
  gmm.set_params(condGMM.means, condGMM.covMats, condGMM.mixCoeffs);
  //gmm.save("variational_model_cond_aspect_angle.gmm");
  arma::uword nSample = reflections.size();
  arma::mat samples = gmm.generate(nSample);
  for (arma::uword i = 0; i < nSample; ++i) {
    reflections[i].z_x = (::std::min)((::std::max)(samples(0, i) + vrmZxOffset, 0.0), 1.0);
    reflections[i].z_y = (::std::min)((::std::max)(samples(1, i) + vrmZyOffset, 0.0), 1.0);
  }
  // DEBUG
  /*nSample = 500;
  samples = gmm.generate(nSample);
  trans(samples).print("Random samples (z_x, z_y):");*/
  // END DEBUG
}
